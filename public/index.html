<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ping Pong Score Counter</title>
    <style>
      body {
        padding: 0;
        margin: 0;
        font-family: Arial, sans-serif;
      }

      .score-container {
        display: flex;
        height: 100vh;
        justify-content: space-between;
        align-items: center;
      }

      .score-box {
        flex: 1;
        height: 100%;
        text-align: center;
        font-size: 26rem;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      .score-box span {
        z-index: 1;
      }

      .green {
        background-color: #a1eebd;
      }

      .blue {
        background-color: #7bd3ea;
      }

      .serving::before,
      .won::after {
        content: "";
        position: absolute;
        opacity: 0.4;
        top: 0;
        background-size: initial;
        background-repeat: repeat;
        width: 100%;
        height: 100%;
      }

      .serving::before {
        background-image: url("table_tennis_paddle_and_ball.png");
      }

      .won::after {
        background-image: url("crown.png");
        opacity: 0.8;
        animation: animatedBackground 10s linear infinite alternate;
      }

      .events-log {
        position: absolute;
        left: 0;
        top: 0;
        font-size: 2rem;
      }

      .events-log ul:not(:empty) {
        list-style: none;
        margin: 0;
        background: rgba(0, 0, 0, 0.2);
        padding: 10px;
      }

      .events-log li {
        padding-top: 3px;
        padding-bottom: 3px;
      }

      .events-log span {
        padding-left: 2px;
        padding-right: 2px;
        display: inline-block;
      }

      .paused {
        margin: 0;
        padding: 0;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);


        position: absolute;
        height: 100%;
        width: 100%;
        font-size: 5rem;
        background: white;
        z-index: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
      }

      .paused.hidden {
        display: none;
      }

      .flash {
        width: 100%;
        height: 100%;
        background-color: white;
        position: absolute;
        z-index: 1;
        opacity: 0;
      }

      .flash.flash-active {
        animation: flashAnimation 0.3s ease-in-out;
      }

      @keyframes flashAnimation {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      @keyframes animatedBackground {
        from {
          background-position: 0 0;
        }
        to {
          background-position: 100% 0;
        }
      }

      h1 {
        font-size: 2.5em;
        color: #FB8500;
        text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black;
      }
      p {
        font-size: 1.2em;
        color: #333;
      }
      .instruction {
        margin-top: 20px;
        padding: 10px;
        background-color: #ffeb3b;
        border-radius: 5px;
        color: #000;
        font-weight: bold;
      }
      .footer {
        margin-top: 20px;
        font-size: 0.9em;
        color: #000;
      }

      .welcome-container {
        z-index: 1;
      }
      .animation-container {
        position: absolute;
        top: 0;
        lefT: 0;
        bottom: 0;
        right: 0;
        background-color: #ffffaaee;
        border: 2px solid #887c00;
        overflow: hidden;
      }
      .ball {
        width: 100px;
        height: 100px;
        background-color: #ffac00;
        border-radius: 50%;
        position: absolute;
      }
      .bat {
        width: 20px;
        height: 280px;
        background-color: #333;
        position: absolute;
        border-radius: 10px;
      }
      .bat-left {
        left: 0;
        top: 50%;
        transform: translateY(-50%);
      }
      .bat-right {
        right: 0;
        top: 50%;
        transform: translateY(-50%);
      }
    </style>
  </head>
  <body>
    <div class="score-container" id="game">
      <div class="score-box green" id="player1"><span>0</span></div>
      <div class="score-box blue" id="player2"><span>0</span></div>
      <div class="events-log" id="events"></div>
      <div class="paused hidden" id="paused">
        <div class="animation-container" id="animationContainer">
          <div class="ball" id="ball"></div>
          <div class="bat bat-left"></div>
          <div class="bat bat-right"></div>
        </div>
        <div class="welcome-container">
          <h1>Let's play<br/>Ping-Pong!</h1>
          <div class="instruction">
            Hold the clicker for 3 seconds to start
          </div>
          <div class="footer">
            Happy Playing!
          </div>
        </div>
        <script type="application/ecmascript">
          const ball = document.getElementById('ball');
          const container = document.getElementById('animationContainer');

          const containerWidth = container.clientWidth;
          const containerHeight = container.clientHeight;
          const ballDiameter = ball.clientWidth;

          let ballPosX = Math.random() * (containerWidth - ballDiameter);
          let ballPosY = Math.random() * (containerHeight - ballDiameter);

          let ballSpeedX = 10;
          let ballSpeedY = 5;

          function animateBall() {
            ballPosX += ballSpeedX;
            ballPosY += ballSpeedY;

            if (ballPosX <= 0 || ballPosX >= container.clientWidth - ball.clientWidth) {
              ballSpeedX = -ballSpeedX;
            }
            if (ballPosY <= 0 || ballPosY >= container.clientHeight - ball.clientHeight) {
              ballSpeedY = -ballSpeedY;
            }

            ball.style.left = ballPosX + 'px';
            ball.style.top = ballPosY + 'px';

            requestAnimationFrame(animateBall);
          }

          animateBall();
        </script>
      </div>
      <div class="flash" id="flash" />
    </div>

    <script type="module">
      import { io } from "https://cdn.socket.io/4.7.3/socket.io.esm.min.js";

      const FRIENDLY_NAMES = {
        player1: "Green",
        player2: "Blue",
      };

      function say(what) {
        let utterance = new SpeechSynthesisUtterance(what);
        speechSynthesis.speak(utterance);
      }

      const socket = io.connect("http://localhost:3000");

      function handleInitialUI() {
        document.getElementById("player1").classList.remove("serving");
        document.getElementById("player2").classList.remove("serving");
        document.getElementById("player1").classList.remove("won");
        document.getElementById("player2").classList.remove("won");

        document.getElementById("player1").innerHTML = `<span>0</span>`;
        document.getElementById("player2").innerHTML = `<span>0</span>`;
        document.getElementById("events").innerHTML = "";
      }

      socket.on("gameRestart", handleInitialUI);

      socket.on("state", (state) => {
        say(`It's ${state.player1} to ${state.player2}`);
        console.log("state", state);

        if (state.gamePaused) {
          document.getElementById("paused").classList.remove("hidden");
        } else {
          document.getElementById("paused").classList.add("hidden");
        }

        if (state.serving === "player2") {
          document.getElementById("player1").classList.remove("serving");
          document.getElementById("player2").classList.add("serving");
        } else {
          document.getElementById("player2").classList.remove("serving");
          document.getElementById("player1").classList.add("serving");
        }

        document.getElementById("player1").innerHTML =
          `<span>${state.player1}</span>`;
        document.getElementById("player2").innerHTML =
          `<span>${state.player2}</span>`;

        if (state.gameOver) {
          const name = event.player === "player1" ? "Green" : "Blue";
          say(`${name} won the game! Congratulations!`);

          document.getElementById(state.winner).classList.add("won");
          document.getElementById("player1").classList.remove("serving");
          document.getElementById("player2").classList.remove("serving");
        }

        document.getElementById("events").innerHTML = `<ul>${state.events
          .map((event) => {
            const color = event.player === "player1" ? "green" : "blue";

            if (event.type === "score") {
              return `<li><span class="${FRIENDLY_NAMES[
                event.player
              ].toLowerCase()}">${
                FRIENDLY_NAMES[event.player]
              }</span> has scored!</li>`;
            } else if (event.type === "gameOver") {
              return `<li><span class="${color}"><strong>${
                FRIENDLY_NAMES[event.player]
              }</strong></span> has won the game!</li>`;
            }
          })
          .reverse()
          .join("")}</ul>`;
      });

      socket.on("servingChange", (serving) => {
        console.log("servingChange", serving);

        say(`${FRIENDLY_NAMES[serving]} is serving`);
      });

      socket.on("keyPressed", (device) => {
        console.log("keyPressed", device);
        document.getElementById("flash").classList.add("flash-active");
        setTimeout(() => {
          document.getElementById("flash").classList.remove("flash-active");
        }, 300);
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from the server");
      });

      socket.on("connect", handleInitialUI);
    </script>
  </body>
</html>
